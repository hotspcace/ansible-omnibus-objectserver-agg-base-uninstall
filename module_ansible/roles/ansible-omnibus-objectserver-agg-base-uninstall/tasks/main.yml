---

##########################################################
# Create Directories for mount points
##########################################################
- name: create directories
  file:
    path: /opt/IBM
    state: absent 
    owner: netcool
    group: ncoadmin
    mode: 0775
    recurse: yes

- name: create directories
  file:
    path: /opt/accuoss/repository
    state: absent 
    owner: netcool
    group: ncoadmin
    mode: 0775
    recurse: yes
###########################################################

########################################################
# Create Directories on remote instance
########################################################
- name: create scripts directory
  file:
    path: /opt/accuoss/omnibus/scripts
    state: absent 
    owner: netcool
    group: ncoadmin
    mode: 0775

- name: create host config directory for objectserver
  file:
    path: /opt/accuoss/omnibus/configs/objectserver
    state: absent
    owner: netcool
    group: ncoadmin
    mode: 0775

- name: create host config directory for objectserver
  file:
    path: /opt/accuoss/omnibus/logs/objectserver
    state: absent
    owner: netcool
    group: ncoadmin
    mode: 0775

- name: create InstallManager directory for objectserver
  file:
    path: /home/netcool/InstallationManager
    state: absent
    owner: netcool
    group: ncoadmin
    mode: 0775

- name: create repository directory for objectserver
  file:
    path: /home/netcool/repository/core 
    state: absent
    owner: netcool
    group: ncoadmin
    mode: 0775

#########################################################
## Copy Files to remote server
##########################################################
#- name: copy objectserver install response file
#  copy:
#    src: objectserver-response.xml
#    dest: /opt/accuoss/omnibus/configs/objectserver/objectserver-response.xml
#    owner: netcool
#    group: ncoadmin
#    mode: 0775
#    force: no 
#
#- name: copy
#  copy:
#    src: get_objsrv_props.sql
#    dest: /opt/accuoss/omnibus/configs/objectserver
#    owner: netcool
#    group: ncoadmin
#    mode: 0775
#    force: no 

#- name: copy scripts to script directory
#  copy:
#    src: mkbk.sh
#    dest: /opt/accuoss/omnibus/scripts
#    owner: netcool
#    group: ncoadmin
#    mode: 0775
#    force: no 

#- name: copy scripts to script directory
#  copy:
#    src: pamanager.sh
#    dest: /opt/accuoss/omnibus/scripts
#    owner: netcool
#    group: ncoadmin
#    mode: 0775
#    force: no 

#- name: copy scripts to script directory
#  copy:
#    src: bkp_hist.sh
#    dest: /opt/accuoss/omnibus/scripts/
#    owner: netcool
#    group: ncoadmin
#    mode: 0775
#    force: no 

#- name: copy scripts to script directory
#  copy:
##    src: omni_env.sh 
#    dest: /opt/accuoss/omnibus/scripts/
#    owner: netcool
#    group: ncoadmin
#    mode: 0775
#    force: no
######################################################

######################################################
# Install need yum packages
######################################################
- name: Install yum packages using a list
  become: True
  yum:
    state: removed
    name:
      - tar
      - hostname
      - unzip
      - audit-libs
      - fontconfig
      - freetype
      - compat-libstdc++-33.i686
      - glibc.i686
      - gtk2
      - libICE
      - libSM
      - libX11
      - libXau
      - libXcursor
      - libXext
      - libXft
      - libXmu
      - libXp
      - libXpm
      - libXrender
      - libXt
      - libXtst
      - libstdc++.i686
      - libgcc.i686
      - libjpeg-turbo
      - libpng12
      - motif
      - dejavu-fonts-common
      - dejavu-sans-fonts
      - expat
      - glibc
      - libgcc
      - libidn
      - libstdc++
      - libuuid
      - libxcb
      - nss-softokn-freebl
      - pam
      - zlib
      - nss-softokn-freebl.i686
      - compat-libstdc++-33
      - git
      - logrotate
      - strace
      - vim
      - bc
      - pam.i686
      - xorg-x11-xauth.x86_64
      - xorg-x11-apps-7.7-7.el7.x86_64
      - xterm

###########################################################
# Uninstall Installation Manager 
###########################################################
- name: Install IBM Install Manager
  shell: "/root/var/ibm/InstallationManager/uninstall/uninstall --launcher.ini /root/var/ibm/InstallationManager/uninstall/silent-uninstall.ini"
  #shell: "/root/var/ibm/InstallationManager/uninstall/uninstall --launcher.ini /home/netcool/InstallationManager/user-silent-install.ini -installationDirectory /home/netcool/IBM -acceptLicense -ShowVerboseProgress"
  become: true 

############################################################
# Check Objectserver DB Path
############################################################
- stat: path=/opt/IBM/tivoli/netcool/omnibus/db/AGG_P
  register: objsrv_aggp_db_path

- debug: msg="The objectserver db path was not found so it will be installed."
  when: objsrv_aggp_db_path.stat.exists != True
- debug: msg="The objectserver db path was found so this step will be skipped."
  when: objsrv_aggp_db_path.stat.exists == True
############################################################

############################################################
## Objectserver Install
#############################################################
- unarchive:
    src: /opt/accuoss/software/Software/NOI/OMNIbus/TVL_NTCL_OMN_V8.1.0.24_CORE_LNX.zip
    dest: /home/netcool/repository/core
    remote_src: True
  become_user: netcool
  become: yes
  become_method: enable
  when: objsrv_aggp_db_path.stat.exists != True

- name: Install IBM Omnibus ObjectServer
  shell: "touch /home/netcool/repository/core/objectserver_install.log; /home/netcool/IBM/eclipse/tools/imcl -input /opt/accuoss/omnibus/configs/objectserver/objectserver-response.xml -silent -nosplash -acceptlicense -ShowVerboseProgress -log /home/netcool/repository/core/objectserver_install.log"
  become: yes
  become_user: netcool
  when: objsrv_aggp_db_path.stat.exists != True

##################################################################
# Run Script to make hosts file
##################################################################
#- name: Create /etc/hosts file
#  shell: "cd /opt/accuoss/omnibus/configs/objectserver && ./make_host_file.sh"
#  become_user: netcool
#  become: yes
#  become_method: enable
##################################################################

###################################################################
# Check Objectserver DB Path
###################################################################
- stat: path=/opt/IBM/tivoli/netcool/omnibus/db/AGG_P
  register: objsrv_aggp_db_path

- debug: msg="The objectserver db path was not found so it will be installed."
  when: objsrv_aggp_db_path.stat.exists != True
- debug: msg="The objectserver db path was found so this step will be skipped."
  when: objsrv_aggp_db_path.stat.exists == True
##################################################################

##################################################################
# Create DB if it does not exist
##################################################################
- name: Create the objectserver DB
  shell: "/opt/IBM/tivoli/netcool/omnibus/bin/nco_dbinit -server AGG_P -force -customconfigfile /opt/IBM/tivoli/netcool/omnibus/extensions/multitier/objectserver/aggregation.sql,/opt/accuoss/omnibus/configs/objectserver/vs_custom_users_and_groups.sql,/opt/accuoss/omnibus/configs/objectserver/vs_add_columns.sql,/opt/accuoss/omnibus/configs/objectserver/vs_custom_triggers.sql"
  become_user: netcool
  become: yes
  become_method: enable
  when: objsrv_aggp_db_path.stat.exists != True
##################################################################

##################################################################
# Install nco startup file if it does not exist
##################################################################
- stat: path=/etc/init.d/nco
  register: nco_startup_path

- debug: msg="The nco startup path /etc/init.d/nco was not found so it will be installed."
  when: nco_startup_path.stat.exists != True
- debug: msg="The nco startup path /etc/init.d/nco was found so this step will be skipped."
  when: nco_startup_path.stat.exists == True

#########################################################
### Copy Files to remote server
###########################################################
- name: copy nco script to /opt/init.d 
  copy:
    src: segra_files/nco
    dest: /etc/init.d
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes

- name: copy omni.dat file to all needed locations 
  copy:
    src: segra_files/omni.dat
    dest: /opt/IBM/tivoli/netcool/etc 
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes

- name: copy omni.dat file to all needed locations
  copy:
    src: segra_files/omni.dat
    dest: /opt/IBM/tivoli/netcool/omnibus/etc
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes

- name: copy omni.dat file to all needed locations
  copy:
    src: segra_files/omni.dat
    dest: /opt/accuoss/omnibus/configs/objectserver 
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes

- name: copy AGG_P_PA.props to needed locations 
  copy:
    src: segra_files/AGG_P_PA.props
    dest: /opt/accuoss/omnibus/configs/objectserver
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes

- name: copy AGG_P_PA.conf to needed locations
  copy:
    src: segra_files/AGG_P_PA.conf
    dest: /opt/accuoss/omnibus/configs/objectserver
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes

- name: copy AGG_P_PA.conf to needed locations
  copy:
    src: segra_files/AGG_P.props
    dest: /opt/accuoss/omnibus/configs/objectserver
    owner: netcool
    group: ncoadmin
    mode: 0775
    force: yes
#############################################################

#############################################################
# Run Script to make .bashrc entries 
#############################################################
- name: Create ~/.bashrc file
  shell: "/opt/accuoss/omnibus/scripts/omni_env.sh perm"
  become: yes
  become_user: netcool
#############################################################

#############################################################
# Run nco_igen
#############################################################
- name: Run nco_igen
  shell: "/opt/IBM/tivoli/netcool/bin/nco_igen -in /opt/accuoss/omnibus/configs/objectserver/omni.dat"
  become: yes
  become_user: netcool
#############################################################


#- name: Install nco startup file if it does not exist
#  shell: "cp /opt/accuoss/omnibus/configs/objectserver/nco /etc/init.d/; /sbin/chkconfig --add nco > /dev/null; systemctl daemon-reload"
#  become: true
#  register: install_nco
#  environment:
#      OMNIHOME: /opt/IBM/tivoli/netcool/omnibus
#      NCHOME: /opt/IBM/tivoli/netcool
#  args:
#    executable: /bin/bash
#  when: nco_startup_path.stat.exists != True
#
#- name: Debug install_nco
#  debug: var=install_nco
################################################################

################################################################
# Run script to create bashrc files for omniadmin and root
################################################################
#- name: Run script that sets environment variables and alias' for omniadmin and root
#  shell: "cd /tmp; ./global_bashrc.sh"
#  become: true
#  register: install_bashrc
#  environment:
#      OMNIHOME: /opt/IBM/tivoli/netcool/omnibus
#      NCHOME: /opt/IBM/tivoli/netcool
#  args:
#    executable: /bin/bash
#
#- name: Debug install_bashrc
#  debug: var=install_bashrc
###############################################################

###############################################################
# Check to see if PAD process is already running
###############################################################
- name: Check status of PAD process
  shell: "ps -ef|grep nco_pad|grep -v grep|cut -d' ' -f24|cut -d'/' -f10"
  become_user: netcool
  become: yes
  become_method: enable
  register: pad_status

- name: Debug PAD Status
  debug: var=pad_status.stdout
##############################################################

##############################################################
# Check to see if Objectserver process is already running
##############################################################
- name: Check status of objectserver process
  shell: "ps -ef|grep nco_objserv|grep -v grep|cut -d' ' -f20|cut -d'/' -f10"
  become_user: netcool
  become: yes
  become_method: enable
  register: objsrv_status

- name: Debug Objectserver Process Status
  debug: var=objsrv_status.stdout
##############################################################

########################################################
# Set permissions on files for netcool
########################################################
- name: Set permissions for netcool on omnibus files
  shell: "setfacl -m u:netcool:rwX /etc/shadow && setfacl -m u:netcool:rwX /etc/init.d/nco && setfacl -m u:netcool:r /etc/passwd && setfacl -m u:netcool:r /etc/group"
  become: true
########################################################

########################################################
# Run startup script for PAD
########################################################
- name: Run Startup script
  shell: "/etc/init.d/nco start"
  become: yes
  become_user: netcool
  environment:
      OMNIHOME: /opt/IBM/tivoli/netcool/omnibus
      NCHOME: /opt/IBM/tivoli/netcool
  register: nco_start
  when: pad_status.stdout != 'nco_pad'

- name: Debug NCO Start
  debug: var=nco_start.stdout
  when: pad_status.stdout != 'nco_pad'
########################################################

########################################################
# Stop PAD and all processes using startup script
########################################################
#- name: Stop the probe using nco stop / nco start
#  service:
#    name: nco
#    state: stopped

#- name: Stop PAD
#  shell: "source /home/omniadmin/.bashrc && /etc/init.d/nco stop"
#  become: true
#  environment:
#      OMNIHOME: /opt/IBM/tivoli/netcool/omnibus
#      NCHOME: /opt/IBM/tivoli/netcool
#  register: stop_pad
#
#- name: Debug Stopping PAD
#  debug: var=stop_pad.stdout
########################################################

########################################################
# Start PAD and all processes using startup script
########################################################
#- name: Restart the probe using nco stop / nco start
#  service:
#    name: nco
#    state: started

#- name: Start PAD
#  shell: "source /home/omniadmin/bashrc; /etc/init.d/nco start"
#  become: true
#  environment:
#      OMNIHOME: /opt/IBM/tivoli/netcool/omnibus
#      NCHOME: /opt/IBM/tivoli/netcool
#  register: start_pad
#
#- name: Debug Starting PAD
#  debug: var=start_pad.stdout
########################################################
#- name: Stop the probe using nco stop / nco start
#  service:
#    name: nco
#    state: stopped
#
#- name: Restart the probe using nco stop / nco start
#  service:
#    name: nco
#    state: started
########################################################

########################################################
# Remove omnibus admin accounts
########################################################
- group:
    name: ncoadmin
    gid: 5500
    state: absent

- user:
    name: root
    comment: "Add root user to ncoadmin group"
    group: ncoadmin
    append: yes
    state: absent
  become: true

- user:
    name: netcool
    comment: "Omnibus admin account"
    uid: 10001
    shell: /bin/bash
    home: /home/netcool
    group: ncoadmin
    state: absent
    remove: yes
    password: "$6$ulGOJh6254sgt8QS$C/XftgH.MkMor2X.GbZLIlsfSHKRkHjqAANtiV0zlARH2R7m2.Kis.DICdm.45A7ntp0ImCndPutANY68.PSA/"
  become: true
######################################################
